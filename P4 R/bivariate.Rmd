---
title: "bivariate"
author: "mnshr"
date: "April 17, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.

library(ggplot2)
library(GGally)
library(gridExtra)
library(dplyr)
library(RColorBrewer)
#library(ellipse)
library(reshape)
library(memisc)
library(scales)
library(pander)
library(knitr)

#Subsets data according to the proportion required
subSetter <- function(x, col, fraction) {
  subs <- quantile(x[[col]], probs=fraction)
  mydata <- subset(x, x[[col]] < subs)
  return (mydata)
}
```
# Bivariate Plots Section

I will be exploring the relationship among pairs of variables in this section. Beginning with a correlation matrix chart to get an idea in general about the relationship among variables I got me interested in the Univariate analysis section.

```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
ggcorr(dplyr::select(pd, 5, 9, 16, 21, 26, 27, 30:38, 41, 42, 47, 50, 52, 54, 57, 58, 60, 62, 64, 81, 86), #9:18
       low = "darkgreen", mid = "white", high = "darkblue", label = TRUE, 
       angle = -15, size = 4, hjust = 0.9, label_round = 2, layout.exp = 2) +
  ggtitle("Correlation Matrix")

```
The generated graph is extremely busy but I am able to identify some of the variables which don't show much correlation with others. Variables such as Term, EmploymentStatusDuration, ProsperScore, LoanCurrentDaysDelinquent, DelinquenciesLast7Years, ProsperPrincipalOutstanding are not showing correlation with others and hence I removed them in the following correlation matrix to reduce the density of information in the matrix.

```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
#MeanCreditScore, ProsperCreditRating

# Correlation matrix among numerical variables
ggcorr(dplyr::select(pd, 9, 26, 27, 30:35, 37, 41, 42, 47, 50, 52, 54, 57, 62, 64, 81, 86), #9:18
       low = "darkgreen", mid = "white", high = "darkblue", label = TRUE, 
       angle = -15, size = 4, hjust = 0.9, label_round = 2, layout.exp = 2, geom = "circle") +
  ggtitle("Correlation Matrix")
```
There are some interesting observations in the graph above. First of all we can ignore the correlation of 1 among MeanCreditScore and the 2 CreditScoreRange [Upper/Lower] variables, since the mean is derived from the 2. The 4 variables, OpenRevolvingMonthlyPayment, OpenRevolvingAccounts, OpenCreditLines and TotalCreditLinesPast7Years are all strongly related to each other ranging from 0.5 to 0.82
Next highest correlation is between RevolvingCreditBalance and OpenRevolvingMonthlyPayment at 0.76, indicating that the payment tends to be usually equal to the Balance amount although it may not be always the case. The correlation between TotalInquiries and InquiriesLast6Months is also strong at 0.74, which is an obviously strong relationship. TotalProsperLoans and OnTimeProsperPayments correlation is at 0.7 which indicates that the On time payment record is a strong factor in getting the borrowers more loans.
On the negative correlation front, variables BorrowerRate, MeanCreditScore show a correlation of -0.46 while MeanCreditScore and BankCardUtilization show a correlation score of -0.41.

In my analysis further I will also include the categorical variables along with continuous ones.

MeanCreditScore vs LoanOriginalAmount
```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
cor.test(pd$MeanCreditScore, pd$LoanOriginalAmount)
ggplot(aes(x = LoanOriginalAmount, y = MeanCreditScore),
       data = subset(pd, !is.na(ProsperCreditRating))) +
  scale_x_sqrt()+
  geom_line(stat='summary', fun.y=median, fun.x=median) +
  coord_cartesian(ylim = c(400,850)) + 
  geom_smooth()

ggplot(aes(x=LoanOriginalAmount, y=MeanCreditScore), 
       data=pd) + #subSetter(pd,"LoanOriginalAmount", 0.95)) +
  geom_jitter(alpha=0.20, aes(color=ProsperCreditRating)) 
```
We can observe a general increasing trend of MeanCreditScore as the LoanOriginalAmount increases. The loan amount is square root transformed. Although the graph shows lot of variation in Credit Score for most of the loan amounts, except the very high ones. At high loan amounts the Credit Scores are found to be among the highest.

MeanCreditScore vs BorrowerRate
```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
cor.test(pd$MeanCreditScore, pd$BorrowerRate)

ggplot(aes(x = BorrowerRate, y = MeanCreditScore),
       data = subset(pd, !is.na(ProsperCreditRating))) +
  scale_x_sqrt()+
  geom_line(stat='summary', fun.y=median, fun.x=median) +
  coord_cartesian(ylim = c(400,850)) + 
  geom_smooth()

ggplot(data = subset(pd, !is.na(ProsperCreditRating)), 
       aes(x = BorrowerRate, y = MeanCreditScore)) +
      geom_smooth()

qplot(data= pd, x = BorrowerRate) +
  facet_wrap(~MeanCreditScore)
```
The correlation shows a negative relation of -0.46 as we had seen in the correlation matrix.
The chart shows a negative relation, except when the interest rate is less than around 0.6% where it shows a sharp increase in the trend. Hence it can be deduced that a very small interest rate is good for the credit score to a threshold after which the credit score declines.

The facet wrap graph histogram shows an approximate normal distribution for loan counts in 650 to 750 range and for higher credit scores the distribution is right skewed due to lower rate charged for them.

MeanCreditScore vs DebtToIncomeRatio
```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
cor.test(pd$MeanCreditScore, pd$DebtToIncomeRatio)

ggplot(aes(x = DebtToIncomeRatio, y = MeanCreditScore),
       data = subset(pd, !is.na(ProsperCreditRating))) +
  scale_x_sqrt()+
  geom_line(stat='summary', fun.y=median, fun.x=median) +
  coord_cartesian(ylim = c(400,850)) + 
  geom_smooth()

ggplot(data = subset(pd, !is.na(ProsperCreditRating)), 
       aes(x = DebtToIncomeRatio, y = MeanCreditScore)) +
      geom_smooth()
```
I see a very small negative correlation and no strong relationship between DebtToIncomeRatio and MeanCreditScore. The second curve also shows a very non-obvious relationship. I was expecting the credit score to fall with a rising debt to income ratio, but since there are many other factors considered to calculate the credit score, from the data we have, the DebtToIncome ratio doesn't seem to be playing a role.

Changing the gears a bit, I compare the newly created Occupation_new categorical variable with the StatedMonthlyIncome to understand whether my intuition regarding categorization on multiple occupation categories in the dataset was correct or not.
```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
ggplot(data=pd,aes(x=Occupation_new,y=StatedMonthlyIncome))+
  geom_boxplot(aes(colour=Occupation_new)) +
  scale_y_log10() +
  coord_cartesian(ylim = c(1000,20000))
```
It can be observed from the box plot, that monthly income is highest for the Distinguished Service, followed by STEM related services, Medical services respectively. As expected Students are the lowest earners. 
I will now try to pair the Occupation_new with MeanCreditScore to get a roughly similar relationship.

```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
ggplot(data=pd,aes(x=Occupation_new,y=MeanCreditScore))+
  geom_boxplot(aes(colour=Occupation_new)) +
  coord_cartesian(ylim = c(600,800))
```
Filtering out the outliers, the box plots fpr MeanCreditScore show a similar relationship as was with the StatedMonthlyIncome. Although since the range for credit score is much lower than the income the differences aren't very clear looking at the 1st and 3rd quantiles of the box plots.

MeanCreditScore vs ProsperCreditRating
```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
ggplot(data=subset(pd, !is.na(ProsperCreditRating)),aes(x=ProsperCreditRating,y=MeanCreditScore))+
  geom_boxplot(aes(colour=ProsperCreditRating)) +
  coord_cartesian(ylim = c(600,800)) +
    scale_y_continuous(limits = c(quantile(pd$MeanCreditScore, 0.05, na.rm=T), 
                                quantile(pd$MeanCreditScore, 0.95, na.rm=T)))


qplot(data= subset(pd, !is.na(MeanCreditScore)), x = ProsperCreditRating) +
  facet_wrap(~MeanCreditScore)

ggplot(data=pd,aes(x=MeanCreditScore))+
  geom_histogram(binwidth=10, position = "identity")+
  #scale_y_log10()+
  facet_wrap(~ProsperCreditRating,3)
```
I charted two different types of graphs, a box plot and a facet wrap. In the box plot it can be seen that  median credit score is highest for AA and then it goes down for A, B upto E. The median for HR is higher than E's median due to outliers with very high MeanCreditScore.

The facet chart shows an approximate normal distribution for ProsperCreditRating categories for  MeanCreditScore present in the range 650 to 750. At higher credit score we can see the distribution tending to be right skewed due to dwindling number with poor Prosper ratings at higher MeanCreditScore.

MonthlyLoanPayment vs MeanCreditScore
```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
cor.test(pd$MeanCreditScore, pd$MonthlyLoanPayment)

ggplot(aes(x = MonthlyLoanPayment, y = MeanCreditScore),
       data = subset(pd, !is.na(ProsperCreditRating))) +
  scale_x_sqrt()+
  geom_line(stat='summary', fun.y=median) +
  coord_cartesian(ylim = c(400,850)) + 
  geom_smooth()

ggplot(data = subset(pd, !is.na(ProsperCreditRating)), 
       aes(x = MonthlyLoanPayment, y = MeanCreditScore)) +
      geom_smooth()

```
The correlation shows a value of around 0.3 which is also reflected in the 2 charts that follow.

MeanCreditScore vs Term
```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
cor.test(pd$MeanCreditScore, pd$Term)
ggplot(data = pd, aes(x = as.factor(Term), y = MeanCreditScore)) +
  geom_boxplot() + 
  scale_y_continuous(limits = c(quantile(pd$MeanCreditScore, 0.05, na.rm=T), 
                                quantile(pd$MeanCreditScore, 0.95, na.rm=T)))
```
The correlation is very low at 0.12. The box plot shows that for loans of shorter term as well as longer term the MeanCreditScore is higher, with a greater inter-quartile range for 12 month term. The loan term of 36 months is much larger in number of loans and correlate with a larger range of credit score even though the interquartile range is smaller.

MeanCreditScore vs LoanStatus
```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
ggplot(data = pd, aes(x = as.factor(LoanStatus), y = MeanCreditScore)) +
  geom_boxplot(aes(colour=LoanStatus)) + 
  scale_y_continuous(limits = c(quantile(pd$MeanCreditScore, 0.05, na.rm=T), 
                                quantile(pd$MeanCreditScore, 0.95, na.rm=T)))

```
The categorical variable LoanStatus shows an obvious relationship with MeanCreditScore. The credit score is high for Current and Completed loans. But for Charged-off and Defaulted loans are clearly lower. The Past Due categories are flat across the 6 past due categories. An interesting thing to note is that for FinalPaymentInProgress and Completed loans the credit scores are lower than Current loans.

MeanCreditScore vs BankcardUtilization
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Bivariate_Plots}
summary(pd$BankcardUtilization)
cor.test(pd$MeanCreditScore, pd$BankcardUtilization)
ggplot(pd,aes(x=BankcardUtilization, y=MeanCreditScore))+
  xlim(quantile(pd$BankcardUtilization,0.05, na.rm=T), 
       quantile(pd$BankcardUtilization,0.95, na.rm=T))+
  geom_point(alpha=0.05)+
  geom_smooth(method = 'lm', color= 'red')

```
Negative trend is visible

MeanCreditScore vs LoanOriginationDate
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Bivariate_Plots}
ggplot(data = subset(pd, !is.na(ProsperCreditRating)), 
       aes(x = LoanOriginationDate, y = MeanCreditScore)) +
      geom_smooth()
```
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Bivariate_Plots}
```

##############

```{r echo=FALSE, cache=TRUE, cache.path s= 'cache/', fig.path='figure/', Bivariate_Plots}
ggplot(data = pd, aes(x = BorrowerRate, y = LoanOriginalAmount)) +
  geom_smooth(aes(color=Occupation_new))

ggplot(data = pd, aes(x = DebtToIncomeRatio, y = LoanOriginalAmount)) +
  geom_smooth()

ggplot(data=pd,aes(x=ProsperCreditRating,y=TotalInquiries))+
  geom_boxplot(aes(colour=ProsperCreditRating)) +
  coord_cartesian(ylim = c(0,150))

#??
ggplot(data=pd,aes(x=ProsperCreditRating,y=CurrentDelinquencies))+
  geom_boxplot(aes(colour=ProsperCreditRating)) +
  coord_cartesian(ylim = c(0,50))

ggplot(data=pd,aes(x=ProsperCreditRating,y=OnTimeProsperPayments))+
  geom_boxplot(aes(colour=ProsperCreditRating)) +
  coord_cartesian(ylim = c(0,50))

ggplot(data=pd,aes(x=ProsperCreditRating,y=DebtToIncomeRatio))+
  geom_boxplot(aes(colour=ProsperCreditRating)) +
  coord_cartesian(ylim = c(0,1))

qplot(data= pd, x = ProsperCreditRating) +
  facet_wrap(~IncomeRange)

qplot(data= pd, x = ProsperCreditRating) +
  facet_wrap(~Term)

ggplot(data=pd,aes(x=Term))+
  geom_histogram(binwidth=10, position = "identity")+
  #scale_y_log10()+
  facet_wrap(~ProsperCreditRating,3)

ggplot(data=pd,aes(x=ProsperCreditRating,y=LoanOriginalAmount))+
  geom_boxplot(aes(colour=ProsperCreditRating))

ggplot(data=pd,aes(x=ProsperCreditRating,y=MonthlyLoanPayment))+
  geom_boxplot(aes(colour=ProsperCreditRating))

qplot(data= pd, x = ProsperCreditRating) +
  facet_wrap(~LoanStatus)

ggplot(data = pd, aes(x = pd$ProsperCreditRating, y = pd$Investors)) +
  geom_boxplot(aes(colour=ProsperCreditRating)) + coord_cartesian(ylim = c(0,280))

ggplot(data=pd,aes(x=ProsperScore))+
  geom_histogram(binwidth=2, position = "identity")+
  #scale_y_log10()+
  facet_wrap(~ProsperCreditRating,3)

table(pd$BankcardUtilization)
ggplot(data=pd,aes(x=ProsperCreditRating,y=BankcardUtilization))+
  geom_boxplot(aes(colour=ProsperCreditRating)) +
coord_cartesian(ylim = c(0,3))

qplot(data= pd, x = BorrowerRate) +
  facet_wrap(~ProsperCreditRating)

```
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Bivariate_Plots}
qplot(data= pd, x = ProsperCreditRating) +
  facet_wrap(~CreditRange)

ggplot(data = subset(pd, ListingCategory..numeric. == 1 & 
                             ListingCategory..numeric. != 0), 
             aes(x=DebtToIncomeRatio)) +
  geom_histogram(binwidth = 0.01) + 
  scale_x_continuous(limits = c(0,1)) + 
  labs(title = "Consolidation Loan") + 
  scale_y_sqrt() + 
  geom_vline(aes(xintercept=mean(subset(pd, ListingCategory..numeric. == 1 
                                        & ListingCategory..numeric. 
                                        != 0)$DebtToIncomeRatio, na.rm = T)), 
             color = "blue", size=2)
```
# Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

### What was the strongest relationship you found?

