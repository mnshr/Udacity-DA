# Exploring Prosper Loan Data by MNSHR
========================================================

This project analyzes the loan data provided by Prosper (www.prosper.com) a 
peer to peer lending platform. The feature description about the dataset can
be found at:
A variable dictionary can be found here: https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit#gid=0.

I will perform three types of analyses, Univariate, Bivariate and Multivariate
using preselected variables among the 81 that are part of the dataset and
reflect on my findings in the concluding section. 

```{r echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', packages}
# Load all of the packages that you end up using
# in your analysis in this code chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.

library(ggplot2)
library(GGally)
library(gridExtra)
library(dplyr)
library(RColorBrewer)
#library(ellipse)
library(reshape)
library(memisc)
library(scales)
library(pander)
library(knitr)
```
### Here is a summary of the dataset
```{r echo=TRUE, Load_the_Data}

# Load the Data
pd <- read.csv('./prosperLoanData.csv', sep=',')
#head(pd, 10) --cumbersome
str(pd) # Get the structure of data
dim(pd) # Get the size
names(pd) #Get all columns

```
# Univariate Plots Section

I start the Univariate analysis by developing graphs of select variables of my interest. 
I have divided these variables into 4 broad categories along with the variables represented by them:
 * Borrower - BorrowerRate, Occupation, EmploymentStatus, TotalInquiries, CurrentDeliquencies, RevolvingCreditBalance, OnTimeProsperPayments, DebtToIncomeRatio, IncomeRange
 * Loan - Term, LoanStatus, ProsperPrincipalBorrowed, LoanOriginationDate, LoanMonthsSinceOrigination, MonthlyLoanPayment, PercentFunded, ListingCategory
 * Credit - CreditScoreRangeLower, CreditScoreRangeUpper, FirstRecordedCreditLine, TotalCreditLinespast7years, ProsperRating, ProsperScore
 * Lender - LenderYield, EstimatedReturn

I will explore each variable to develop intuition about each.
### Borrower
#### BorrowerRate

```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}

ggplot(aes(x = BorrowerRate), data = pd) + 
  geom_histogram(binwidth = 0.00500, fill = '#5760AB')
summary(pd$BorrowerRate)
```
I used a bin size of 0.5 in the histogram above. I shows a considerable peak at
0.35% rate with more than 5000 loans. The mean is around 0.2%

#### Occupation
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}

ggplot(data=pd,aes(Occupation))+
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
unique(pd$Occupation)
pd <- mutate(pd, Occupation_new = ifelse(Occupation %in% c("Engineer - Mechanical",
                                          "Scientist",
                                          "Engineer - Electrical",
                                          "Engineer - Chemical",
                                          "Chemist",
                                          "Biologist",
                                          "Computer Programmer",
                                          "Professor",
                                          "Pilot - Private/Commercial"
                                      ), "STEM Service",
                                   ifelse(Occupation %in% 
                                     c("Dentist",
                                      "Doctor",
                                      "Medical Technician",
                                      "Nurse\'s Aide",
                                      "Nurse (LPN)",
                                      "Nurse (RN)",
                                      "Pharmacist",
                                      "Psychologist"
                                      ), "Medical Service",
                                   ifelse(Occupation %in% 
                                     c("Professional",
                                        "Sales - Commission",
                                        "Clerical",
                                        "Teacher",
                                        "Accountant/CPA",
                                        "Food Service Management",
                                        "Administrative Assistant",
                                        "Social Worker",
                                        "Postal Service",
                                        "Analyst",
                                        "Sales - Retail",
                                        "Military Enlisted",
                                        "Flight Attendant",
                                        "Retail Management",
                                        "Military Officer",
                                        "Food Service Management",
                                        "Social Worker",
                                        "Police Officer/Correction Officer",
                                        "Teacher's Aide",
                                        "Homemaker"
                                      ), "General Service",
                                   ifelse(Occupation %in% 
                                     c("Executive",
                                          "Principal",
                                          "Judge",
                                          "Car Dealer",
                                          "Architect",
                                          "Attorney",
                                          "Investor",
                                          "Clergy",
                                          "Realtor",
                                          "Civil Service",
                                          "Religious"
                                      ), "Distinguished Service",                                                                                 ifelse(Occupation %in% 
                                     c("Tradesman - Mechanic",
                                        "Tradesman - Electrician",
                                        "Tradesman - Carpenter",
                                        "Tradesman - Plumber",
                                        "Contruction",
                                        "Landscaping"
                                      ), "Construction Service",
                                   ifelse(Occupation %in% 
                                     c("Laborer",
                                        "Bus Driver",
                                        "Fireman",
                                        "Waiter/Waitress",
                                        "Skilled Labor",
                                        "Food Service",
                                        "Other",
                                        "Truck Driver"
                                      ), "BCollar Service",
                                   ifelse (Occupation %in% 
                                     c("Student - College Freshman",
                                      "Student - College Graduate Student",
                                      "Student - College Junior",
                                      "Student - College Senior",
                                      "Student - College Sophomore",
                                      "Student - Community College",
                                      "Student - Technical School"
                                      ), "Student", "Other"
                                   ))))))))
```
The most popular Occupation entered is 'Other' and the next popular is the 'Professional' category.
We can group different occupation categories and revisit this chart. For example there are 
multiple categories beginning with Student. There are about 70+ types of occupations listed in the dataset. I will try to reduce that to around 7

```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
ggplot(data=pd,aes(Occupation_new))+
  geom_bar(fill = '#5760AB') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
With the new Occupation categorization, we see the most of the loans come from "General Service" and "Blue Collar Services" jobs, although the number of people belonging to these must be high as well and hence a large number of loans.

#### EmploymentStatus

```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Bivariate_Plots}
summary(pd$EmploymentStatus)
ggplot(aes(x = EmploymentStatus), data = pd) + 
  geom_bar(fill = '#5760AB') + 
  scale_x_continuous(breaks = seq(0, 113, 5))
ggplot(aes(x = EmploymentStatusDuration), data = pd) + 
  geom_histogram(binwidth=3, fill = '#5760AB')
summary(pd$EmploymentStatusDuration)
```
A large number of borrowers are employed, the number being 67322+26355 or ~93000 including both Full-Time and Employed categories. The EmploymentStatusDuration graph shows a steady decline in the number of loans holders as the employment duration increases. Median is 67 month whereas max is 755 months. 

#### TotalInquiries
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
summary(pd$TotalInquiries)
ggplot(aes(x = TotalInquiries), data = pd) + 
  scale_y_log10()+
  geom_histogram(binwidth=2, fill = '#5760AB')
```
TotalInquiries have an impact on credit and the summary and the graph show that although the graph peaks in the range of 0 to 6 enquiries, there are few who have inquired for more than 100 times and the max is 379 which is unusually high. I converted the scale on Y axis to log.

#### RevolvingCreditBalance
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
summary(pd$RevolvingCreditBalance)
ggplot(aes(x = RevolvingCreditBalance), data = pd) + 
  scale_y_log10()+
  geom_histogram(binwidth=5000, fill = '#5760AB')
```
The log scaled histogram of RevolvingCreditBalance shows a large number of loans with low credit balance but there are many with greater than 50000 and even few with 0.5 million as credit balance.

#### OnTimeProsperPayments
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
summary(pd$OnTimeProsperPayments)
ggplot(aes(x = OnTimeProsperPayments), data = pd) + 
  geom_histogram(binwidth=3, fill = '#5760AB')
```
This feature shows the number of on time payments the borrower had made on Prosper loans at the time they created this listing. This value will be null if the borrower has no prior loans and hence there are around 92000 entries with NULL. Although this would depend on Term of the loan, the count of on time loans seems to decline as the duration of ontime payment rises.

#### DebtToIncomeRatio
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
summary(pd$DebtToIncomeRatio)
ggplot(aes(x = DebtToIncomeRatio), data = pd) + 
  geom_histogram(binwidth=0.1, fill = '#5760AB')

ggplot(data=pd,aes(x=DebtToIncomeRatio))+
  geom_histogram(binwidth=0.1)+
  scale_x_continuous(limits=c(0,1),breaks=seq(0,1,0.1))
```
The DebtToIncomeRatio is an important feature in determining the credit score of a loan as it indicates the probability of default as the debt-to-income ratio increases. In this histogram, the ratio is 0.2 to 0.3 for more than 30000, the peak. It then declines, but there are few loans which have the ratio as 10, an unusually high number.

#### IncomeRange 
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
summary(pd$IncomeRange)
ggplot(data=pd,aes(IncomeRange))+
  geom_bar(fill = '#5760AB') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
The IncomeRange histogram looks like a normally distributed one wih a large number of loan takers reporting a salary in 25k-50k and 50k-75k ranges. The number of loans with lower and higher salary ranges are small for understandable reasons.

#### StatedMonthlyIncome

```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
summary(pd$StatedMonthlyIncome)
ggplot(data=pd,aes(StatedMonthlyIncome)) +       
geom_histogram(binwidth=500, color=I('black'), fill=I("#c5831d") ) + 
xlim(0,10000)
summary(pd$StatedMonthlyIncome)
```
The StatedMonthlyIncome also shows an approximate normal distribution, with monthly salary ranging from 0 to 175k. The median is 4667.

#### BorrowerState
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Bivariate_Plots}
table(pd$BorrowerState)

ggplot(pd,aes(x=BorrowerState))+
  geom_bar()+
  scale_y_log10()+
  theme(axis.text.x = element_text(face="bold",  
                           size=8, angle=45),
          axis.text.y = element_text(face="bold",  
                           size=8))

qplot(data = pd, x=InquiriesLast6Months, binwidth=3)
qplot(data = pd, x=TotalCreditLinespast7years, binwidth=1)
qplot(data = pd, x=OpenCreditLines, binwidth=1)
qplot(data = pd, x=BorrowerAPR, binwidth = .01)
```
The borrowers are in large numbers from CA at more than 14000, hence I had to log transform the Y axis to plot the state histogram. 

### Loan
#### Term
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
ggplot(data=pd,aes(Term)) + 
  geom_bar(color=I('blue'),fill=I('#78D20b'))
summary(pd$Term)
```
The loan terms are 3 categories, 12, 36 and 60 months with 36 being the most preferred loan term.

#### MonthlyLoanPayment
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
ggplot(data=pd,aes(MonthlyLoanPayment))+
  geom_histogram(binwidth=50,color=I('red'),fill=I('#56B4E9'))+
  scale_x_continuous(limits=c(0,2252),breaks=seq(0,2252,100))
```
Most monthly loan payments lie between 100 and 300, and then few are even above 1000. There are some with 0 payments which looks unusual.

#### LoanOriginalAmount

```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
ggplot(aes(x = LoanOriginalAmount), data = pd) + 
  geom_histogram(binwidth = 1000, fill = '#5760AB') 
summary(pd$LoanOriginalAmount)
```
The loans range from a minimum of 1000 to 35000, with median at 6500. 10000 and 15000 are popular loan amounts as well.

#### LoanStatus
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
ggplot(data=pd,aes(LoanStatus))+
  geom_bar(color=I('black'),fill=I('#56B4E9'))

ggplot(pd,aes(x=LoanStatus))+
  geom_bar()+
  scale_y_log10()+
  theme(axis.text.x = element_text(face="bold",  
                           size=10, angle=45),
          axis.text.y = element_text(face="bold",  
                           size=10))
table(pd$LoanStatus)
summary(pd$LoanStatus)
```
The current status of the loan: Cancelled,  Chargedoff, Completed, Current, Defaulted, FinalPaymentInProgress, PastDue. The PastDue status will be accompanied by a delinquency bucket. Most loans are current, with 56k loans; more than 38k loans are completed. About 12k loans are chargedoff, there are 5k defaults and about 2k loans are past due for multiple durations.

#### LoanMonthsSinceOrigination
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Univariate_Plots}
ggplot(aes(LoanMonthsSinceOrigination), data = pd) + 
  geom_histogram(binwidth = 3, fill = '#5760AB') 
summary(pd$LoanMonthsSinceOrigination)
```
LoanMonthsSinceOrigination: Number of months since the loan originated.
A large number of loansare relateively new with less than one year in age.

### Credit
#### CreditScoreRangeLower and CreditScoreRangeUpper
I will combine these 2 into a single variable and plot a histogram
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Bivariate_Plots}
pd$CreditRange <- paste(pd$CreditScoreRangeLower,"_",pd$CreditScoreRangeUpper)
ggplot(pd, aes(reorder(CreditRange, -table(CreditRange)[CreditRange]))) + 
  geom_bar() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
dim(subset(pd,CreditScoreRangeUpper <739 & CreditScoreRangeLower >640))[1]/dim(pd)[1]
dim(subset(pd,CreditScoreRangeUpper <600 | is.na(CreditScoreRangeUpper)))[1]/dim(pd)[1]

summary(pd$CreditRange)
pd$CreditRange

#Mean Credit Score
pd$MeanCreditScore <- (pd$CreditScoreRangeLower+pd$CreditScoreRangeUpper)/2
qplot(data = pd, x=MeanCreditScore, binwidth = 10)
```
The graph shows that most loans go to borrowers with credit scores between 640 and 740.
About 42% of loans have credit score between 640 and 740.
About 6% of loans are to borrowers with credit below 600 or no credit rating at all. 

#### BankCardUtilization
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Bivariate_Plots}
ggplot(pd,aes(BankcardUtilization)) + 
  geom_density() + xlim(c(0,2))

summary(pd$BankcardUtilization)
```
BankCardUtilization measures the credit utilization when the credit was pulled, the median is 0.6. There are more than 7500 NAs, which means they were taking credit first time. The density plot shows peaks at 0 and 1.

#### ProsperScore
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Bivariate_Plots}
summary(pd$ProsperScore)
ggplot(aes(x = ProsperScore), data = pd) + 
  geom_histogram(binwidth = 1, fill = '#5760AB') 
```
A custom risk score built using historical Prosper data. The score ranges from 1-10, with 10 being the best, or lowest risk score.  Applicable for loans originated after July 2009.
The graph shows an almost normal distribution.

### CreditGrate and ProsperRating
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Bivariate_Plots}
summary(pd$CreditGrade)
summary(pd$ProsperRating..Alpha.)

pd$ProsperCreditRating <- as.factor(ifelse(pd$ProsperRating..Alpha. == "", 
                   as.character(pd$CreditGrade), 
                   as.character(pd$ProsperRating..Alpha.)))

ggplot(aes(x = ProsperCreditRating), data = pd) + 
  geom_bar(fill = '#5760AB') 
```
I have combined the 2 pre2009 and post2009 credit rating measures in the dataset to a new feature called ProsperCreditRating. After plotting a histogram of the same w can see that most of the loans belong to Ratings, B, C and D which is not unusual.

# Univariate Analysis

### What is the structure of your dataset?

A cursory look at all the variables shows that all the variables could be part of a model to determine a measure of risk involved for each loan entry. And based on individual data per loan one could create another model to determine the credit rating of a borrower for a particular loan. Here I assume that credit rating is a dynamic metric which is evaluated on a regular basis based on the repayment pattern during loan servicing perdied. At a macro level we could also determine the state of peer to peer lending business from the perspective of Prosper. 

### What is/are the main feature(s) of interest in your dataset?

When I use popular credit related apps such as CreditKarma and CreditWise I am shown some of the factors that determine my credit rating, these factors include - Oldest credit line, % of credit used, available credit across all credit lines, number of credit enquiries, number of accounts opened and closed, on time payments. This sounds much simpler than the number of variables at hand in the Prosper loan data. Hence I tried to categorize all the 81 variables in broad categories as per my own understanding of the credit industry. The categories and respective variables of my interest include:
  Borrower - BorrowerRate, Occupation, EmploymentStatus, TotalInquiries, CurrentDeliquencies, RevolvingCreditBalance, OnTimeProsperPayments, DebtToIncomeRatio, IncomeRange, BorrowerState  
  Loan - Term, LoanStatus, LoanMonthsSinceOrigination, MonthlyLoanPayment, ListingCategory
  Credit - CreditScoreRangeLower, CreditScoreRangeUpper, ProsperRating, ProsperScore

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

  Borrower - StatedMonthlyIncome, InvestmentFromFriendsCount, InvestmentFromFriendsAmount, BorrowerState, AmountDelinquent, InquiriesLast6Months, DelinquenciesLast7Years, TradesNeverDelinquent, BankcardUtilization, IsBorrowerHomeOwner
  Loan - PercentFunded, ProsperPrincipalBorrowed, LoanOriginationDate, ListingCategory
  Credit - FirstRecordedCreditLine, TotalCreditLinespast7years

### Did you create any new variables from existing variables in the dataset?

Yes, following are the variables I derived from the dataset:
* CreditScoreRange by combining the Lower and Upper and taking an average
* Occupation grouped together to create smaller number of categories - Occupation_new
* Combined ProsperRating..Alpha and CrediGrade to create ProsperCreditRating

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

# Multivariate Plots Section

```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Multivariate_Plots}
ggpairs()
```
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Bivariate_Plots}
```

# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

### Were there any interesting or surprising interactions between features?

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.


------

# Final Plots and Summary
#### Tip: Polish up the plots that you explored earlier in the report in the final plots section. Make sure you label and title the plots, and provide a description of what can be observed in each of the chosen plots.
### Plot One
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Plot_One}

```

### Description One


### Plot Two
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Plot_Two}

```

### Description Two


### Plot Three
```{r echo=FALSE, cache=TRUE, cache.path = 'cache/', fig.path='figure/', Plot_Three}

```

### Description Three

------

# Reflection


####  Tip When plotting on a log scale, it is useful to note that 3 is about halfway between 1 and 10. As a side note, try not to plot counts on a log scale since counts of 0 are undefined and counts of 1 have a value of 0 (no height).
##### Tip: You can change the height and width of plots in code chunks with the fig.height and fig.width parameters in the chunk options.

#### Tip: Be mindful of the number of data points and variables that you put in a correlation matrix or plot matrix: you do not need to include all variables. In addition, you can use other packages not introduced in the associated course to conduct your exploration. Make sure you load them at the beginning of your document so that it is easiest to see which packages are necessary. (The above plot matrix comes from the psych package.)

#### Tip: Even when doing exploration, it can be good to select appropriate color palettes and set plot themes in order to make plots more readable. (The above plots use sequential color palettes from the RColorBrewer package; other variables might require qualitative or diverging palettes.)

#### Tip: Note that performing statistical tests and creating data models are not a required component of the project. Below, the mtable() call uses 'sdigits = 3' to make sure that three digits are printed after the decimal point in the summary statistics.